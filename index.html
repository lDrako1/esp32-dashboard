<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Dashboard Riego ESP32</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: Arial;
    background: #111;
    color: #eee;
    margin: 0;
    padding: 20px;
}

.container {
    display: flex;
    justify-content: center;
    gap: 20px;
}

.box {
    background: #222;
    padding: 20px;
    width: 300px;
    border-radius: 10px;
}

.value {
    font-size: 32px;
    margin: 5px 0;
}

.mode-box {
    background: #222;
    padding: 20px;
    width: 220px;
    border-radius: 10px;
    text-align: center;
}

.mode-box .devices{
    margin-top: 15px;
    display: none;
    text-align: left;
    padding: 10px;
    background: #1a1a1a;
    border-radius: 10px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 55px;
  height: 28px;
}

.switch input { display:none; }

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #555;
  transition: .4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #27ae60;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.devices {
    margin-top: 20px;
    background: #222;
    padding: 20px;
    border-radius: 10px;
    display: none;
}

.device-row {
    margin: 15px 0;
}

.chart-box {
    margin-top: 30px;
    background: #222;
    padding: 20px;
    border-radius: 10px;
}
</style>
</head>

<body>

<h2 style="text-align:center;">ðŸŒ± Dashboard del ESP32</h2>

<div class="container">

    <div class="box">
        <h3>Sensores</h3>

        <p>Temperatura:</p>
        <div id="temp" class="value">-- Â°C</div>

        <p>Humedad Ambiente:</p>
        <div id="hum" class="value">-- %</div>

        <p>Humedad Suelo:</p>
        <div id="soil" class="value">-- %</div>
    </div>

    <div class="mode-box">
        <h3>Modo</h3>

        <label class="switch">
          <input type="checkbox" id="modeSwitch">
          <span class="slider"></span>
        </label>

        <p id="modeLabel">AUTO</p>

        <div class="devices" id="manualPanel">
            <h3>Control Manual</h3>

            <div class="device-row">
                Foco
                <label class="switch" style="float:right;">
                  <input type="checkbox" id="swFoco">
                  <span class="slider"></span>
                </label>
            </div>

            <div class="device-row">
                Ventilador
                <label class="switch" style="float:right;">
                  <input type="checkbox" id="swVent">
                  <span class="slider"></span>
                </label>
            </div>

            <div class="device-row">
                Bomba
                <label class="switch" style="float:right;">
                  <input type="checkbox" id="swBomba">
                  <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- GRÃFICO -->
<div class="chart-box">
    <h3>Temperatura vs Tiempo (minutos)</h3>
    <canvas id="tempChart" width="600" height="250"></canvas>
</div>

<script>
// MQTT
const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt");

client.on("connect", () => {
    console.log("MQTT conectado");

    client.subscribe("esp32/temperatura");
    client.subscribe("esp32/humedad");
    client.subscribe("esp32/suelo");
    client.subscribe("esp32/mode");
});

// === GrÃ¡fico ===
let startTime = Date.now();
let lastPlotTime = 0;

const ctx = document.getElementById("tempChart").getContext("2d");
const tempChart = new Chart(ctx, {
    type: "line",
    data: {
        datasets: [{
            label: "Temperatura (Â°C)",
            data: [],
            borderColor: "#27ae60",
            backgroundColor: "rgba(39,174,96,0.2)",
            borderWidth: 2,
            tension: 0.2
        }]
    },
    options: {
        scales: {
            x: {
                type: "linear",
                title: { display: true, text: "Tiempo (minutos)" }
            },
            y: {
                title: { display: true, text: "Temperatura (Â°C)" },
                suggestedMin: 0,
                suggestedMax: 50
            }
        }
    }
});

// === Mensajes MQTT ===
client.on("message", (topic, message) => {
    let data = message.toString();

    if (topic === "esp32/temperatura") {
        document.getElementById("temp").innerText = data + " Â°C";

        let now = Date.now();

        // Agregar SOLO 1 punto por minuto
        if (now - lastPlotTime >= 60000) {
            lastPlotTime = now;
            let minutes = (now - startTime) / 60000;

            tempChart.data.datasets[0].data.push({
                x: minutes,
                y: parseFloat(data)
            });

            tempChart.update();
        }
    }

    if (topic === "esp32/humedad") {
        document.getElementById("hum").innerText = data + " %";
    }

    if (topic === "esp32/suelo") {
        document.getElementById("soil").innerText = data + " %";
    }

    if (topic === "esp32/mode") {
        let manual = (data === "MANUAL");
        document.getElementById("modeSwitch").checked = manual;
        document.getElementById("modeLabel").innerText = manual ? "MANUAL" : "AUTO";
        document.getElementById("manualPanel").style.display = manual ? "block" : "none";
    }
});

// === Controles manuales ===
document.getElementById("modeSwitch").addEventListener("change", function() {
    let mode = this.checked ? "MANUAL" : "AUTO";
    document.getElementById("modeLabel").innerText = mode;
    document.getElementById("manualPanel").style.display = this.checked ? "block" : "none";
    client.publish("esp32/mode", mode);
});

document.getElementById("swFoco").addEventListener("change", function(){
    client.publish("esp32/cmd/foco", this.checked ? "ON" : "OFF");
});
document.getElementById("swVent").addEventListener("change", function(){
    client.publish("esp32/cmd/vent", this.checked ? "ON" : "OFF");
});
document.getElementById("swBomba").addEventListener("change", function(){
    client.publish("esp32/cmd/bomba", this.checked ? "ON" : "OFF");
});
</script>

</body>
</html>
